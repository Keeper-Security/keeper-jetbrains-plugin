name: Build & Publish Keeper Security JetBrains Plugin
on:
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish to JetBrains Marketplace (uncheck to build only)'
        required: false
        default: true
        type: boolean

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java-version: [21]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Java ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'zulu'
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
      - name: Run tests
        run: ./gradlew test
      - name: Run verification
        run: ./gradlew check

  build-plugin:
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'zulu'
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
      - name: Build plugin
        run: ./gradlew buildPlugin
      - name: Verify plugin
        run: ./gradlew verifyPlugin
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: plugin-build
          path: "build/distributions/*.zip"
          retention-days: 30

  generate-sbom:
    runs-on: ubuntu-latest
    needs:
      - build-plugin
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'zulu'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Copy runtime dependencies for SBOM scanning
        run: |
          echo "Copying runtime dependencies for SBOM scanning..."
          ./gradlew copyDependencies --no-daemon
          echo "Dependencies collected in build/sbom-deps:"
          ls -la build/sbom-deps/

      - name: Install Syft
        run: |
          echo "Installing Syft v1.18.1..."
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /tmp/bin v1.18.1
          echo "/tmp/bin" >> $GITHUB_PATH

      - name: Install Manifest CLI
        run: |
          echo "Installing Manifest CLI v0.18.3..."
          curl -sSfL https://raw.githubusercontent.com/manifest-cyber/cli/main/install.sh | sh -s -- -b /tmp/bin v0.18.3

      - name: Create Syft configuration
        run: |
          cat > syft-config.yaml << 'EOF'
          package:
            cataloger:
              java:
                enabled: true
          EOF

      - name: Generate and upload SBOM
        env:
          MANIFEST_API_KEY: '${{ secrets.MANIFEST_TOKEN }}'
        run: |
          echo "Detecting JetBrains plugin version..."
          VERSION=$(./gradlew properties -q | grep "^version:" | awk '{print $2}')
          if [ -z "$VERSION" ]; then
            VERSION="0.0.1"
            echo "Could not detect version, using default: ${VERSION}"
          else
            echo "Detected version: ${VERSION}"
          fi
          echo "Generating SBOM from build/sbom-deps directory..."
          /tmp/bin/manifest sbom "build/sbom-deps" \
            --generator=syft \
            --name=keeper-security-jetbrains-plugin \
            --version=${VERSION} \
            --output=spdx-json \
            --file=jetbrains-plugin-sbom.json \
            --api-key=${MANIFEST_API_KEY} \
            --publish=true \
            --asset-label=application,sbom-generated,java,jetbrains-plugin \
            --generator-config=syft-config.yaml
          echo "SBOM generated and uploaded successfully: jetbrains-plugin-sbom.json"
          head -n 20 jetbrains-plugin-sbom.json

  publish-marketplace:
    runs-on: ubuntu-latest
    environment: prod
    timeout-minutes: 20
    needs:
      - test
      - build-plugin
      - generate-sbom
    steps:
      - name: Checkout Source 
        uses: actions/checkout@v4
      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'zulu'
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: plugin-build
          path: ./artifacts
      - name: Retrieve Secrets from Keeper Secrets Manager
        id: ksmsecrets
        uses: Keeper-Security/ksm-action@master
        with:
          keeper-secret-config: '${{ secrets.KSM_JETBRAINS_CONFIG }}'
          secrets: |
            0zldTBN8W-kg5kzAPAODvA/custom_field/marketplace_token > MARKETPLACE_TOKEN
            0zldTBN8W-kg5kzAPAODvA/file/certificate_chain.crt > file:certificate_chain.crt
            0zldTBN8W-kg5kzAPAODvA/file/private.pem > file:private.pem
            0zldTBN8W-kg5kzAPAODvA/custom_field/private_key_password > PRIVATE_KEY_PASSWORD
      - name: Detect Plugin Version
        id: version
        run: |
          VERSION=$(./gradlew properties -q | grep "^version:" | awk '{print $2}')
          if [ -z "$VERSION" ]; then
            echo "Error: Could not detect plugin version from Gradle"
            exit 1
          fi
          echo "plugin_version=$VERSION" >> $GITHUB_OUTPUT
      - name: Check if version already exists on JetBrains Marketplace
        id: check-version
        env:
          VERSION: '${{ steps.version.outputs.plugin_version }}'
          PUBLISH_TOKEN: '${{ steps.ksmsecrets.outputs.MARKETPLACE_TOKEN }}'
        run: |
          echo "Checking if version $VERSION already exists..."
          PLUGIN_ID="${{ secrets.JETBRAINS_PLUGIN_ID }}"
          RESPONSE=$(curl -s -H "Authorization: Bearer $PUBLISH_TOKEN" \
            "https://plugins.jetbrains.com/api/plugins/$PLUGIN_ID/updates")
          if echo "$RESPONSE" | grep -q "\"version\":\"$VERSION\""; then
            echo "Version $VERSION already exists on JetBrains Marketplace. Skipping publish."
            echo "should_publish=false" >> $GITHUB_OUTPUT
          else
            echo "Version $VERSION not found. Proceeding with publish."
            echo "should_publish=true" >> $GITHUB_OUTPUT
          fi
      - name: Publish to JetBrains Marketplace
        if: github.event.inputs.publish == 'true' && steps.check-version.outputs.should_publish == 'true'
        env:
          PUBLISH_TOKEN: '${{ steps.ksmsecrets.outputs.MARKETPLACE_TOKEN }}'
          CERTIFICATE_CHAIN: '${{ github.workspace }}/certificate_chain.crt'
          PRIVATE_KEY: '${{ github.workspace }}/private.pem'
          PRIVATE_KEY_PASSWORD: '${{ steps.ksmsecrets.outputs.PRIVATE_KEY_PASSWORD }}'
        run: |
          echo "Publishing Keeper Security JetBrains Plugin v${{ steps.version.outputs.plugin_version }}..."
          ./gradlew signPlugin publishPlugin \
            -Pintellij.publish.token=$PUBLISH_TOKEN \
            -PsignPlugin.certificateChain=$CERTIFICATE_CHAIN \
            -PsignPlugin.privateKey=$PRIVATE_KEY \
            -PsignPlugin.password=$PRIVATE_KEY_PASSWORD
      - name: Upload plugin artifact for testing
        if: ${{ github.event.inputs.publish == 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: jetbrains-plugin-${{ github.run_number }}
          path: ./artifacts/*.zip
      - name: Create Release Summary
        if: github.event.inputs.publish == 'true' && steps.check-version.outputs.should_publish == 'true'
        env:
          VERSION: '${{ steps.version.outputs.plugin_version }}'
        run: |
          echo "## JetBrains Plugin Published Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Plugin:** Keeper Security JetBrains Plugin" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Marketplace:** https://plugins.jetbrains.com/plugin/${{ secrets.JETBRAINS_PLUGIN_ID }}" >> $GITHUB_STEP_SUMMARY
